[#_特殊查询]
=特殊查询

xref:_MoreLikeThis查询[more_like_this]

- 查找与指定文本、文档或集合相似的文档。

xref:_Script查询[script]

- 可以使用脚本作为过滤器来查询，详情请查看 xref:./CompoundQueries.adoc#_function_score查询[function_score查询]。

xref:_Percolate查询[percolate]

- 通过文档查询过滤器。

xref:_Wrapper查询[wrapper]

- 可以接受Json和Yaml类型语句的查询。

[#_MoreLikeThis查询]
==MoreLikeThis查询

查看 https://www.elastic.co/guide/en/elasticsearch/reference/6.2/query-dsl-mlt-query.html[More Like This Query]

[source,java]
----
String[] fields = {"name.first", "name.last"};
String[] texts = {"text like this one"};

moreLikeThisQuery(fields, texts, null)
    .minTermFreq(1)
    .maxQueryTerms(12);
----

[#_Script查询]
==Script查询

查看 https://www.elastic.co/guide/en/elasticsearch/reference/6.2/query-dsl-script-query.html[Script Query]

[source,java]
----
scriptQuery(
        new Script("doc['num1'].value > 1")
    );
----

如果数据节点上已经存储脚本，例如叫 **myscript.painless** ：

[source,java]
----
doc['num1'].value > params.param1
----

这是就可以使用：

[source,java]
----
Map<String, Object> parameters = new HashMap<>();
parameters.put("param1", 5);
scriptQuery(new Script(
        //脚本类型：ScriptType.FILE、ScriptType.INLINE或ScriptType.INDEXED
        ScriptType.STORED,
        //脚本引擎
        null,
        //脚本名
        "myscript",
        //类型是Map<String, Object>
        singletonMap("param1", 5)));
----

[#_Percolate查询]
==Percolate查询

查看 https://www.elastic.co/guide/en/elasticsearch/reference/6.2/query-dsl-percolate-query.html[Percolate Query]

[source,java]
----
Settings settings = Settings.builder().put("cluster.name", "elasticsearch").build();
TransportClient client = new PreBuiltTransportClient(settings);
client.addTransportAddress(new InetSocketTransportAddress(new InetSocketAddress(InetAddresses.forString("127.0.0.1"), 9300)));
----

在使用 **percolate** 查询之前，应该添加 **percolate** 的映射，并且应该对包含 **percolate** 查询的文档建立索引：

[source,java]
----
// create an index with a percolator field with the name 'query':
client.admin().indices().prepareCreate("myIndexName")
                        .addMapping("query", "query", "type=percolator")
                        .addMapping("docs", "content", "type=text")
                        .get();

//This is the query we're registering in the percolator
QueryBuilder qb = termQuery("content", "amazing");

//Index the query = register it in the percolator
client.prepareIndex("myIndexName", "query", "myDesignatedQueryName")
    .setSource(jsonBuilder()
        .startObject()
            .field("query", qb) // Register the query
        .endObject())
    .setRefreshPolicy(RefreshPolicy.IMMEDIATE) // Needed when the query shall be available immediately
    .get();
----

查询语句在 **myDesignatedQueryName** 的下面。

为了根据以注册的查询检查文档，请使用：

[source,java]
----
//Build a document to check against the percolator
XContentBuilder docBuilder = XContentFactory.jsonBuilder().startObject();
docBuilder.field("content", "This is amazing!");
docBuilder.endObject(); //End of the JSON root object

PercolateQueryBuilder percolateQuery = new PercolateQueryBuilder("query", "docs", docBuilder.bytes());

// Percolate, by executing the percolator query in the query dsl:
SearchResponse response = client().prepareSearch("myIndexName")
        .setQuery(percolateQuery))
        .get();
//Iterate over the results
for(SearchHit hit : response.getHits()) {
    // Percolator queries as hit
}
----

[#_Wrapper查询]
==Wrapper查询

查看 https://www.elastic.co/guide/en/elasticsearch/reference/6.2/query-dsl-wrapper-query.html[Wrapper Query]

[source,java]
----
//在query builder中定义查询
String query = "{\"term\": {\"user\": \"kimchy\"}}";
wrapperQuery(query);
----
